<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLIXGO - Movie Management</title>
    <link rel="icon" type="image/png" href="assets/favicon-32x32.png">
    <link rel="stylesheet" href="css/movieManagement.css">
    <style>
        /* Added styles for posters */
        .placeholder-poster {
            width: 120px;
            height: 180px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
            overflow: hidden;
            word-break: break-word;
        }

        .table-poster {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        .image-preview img {
            max-width: 120px;
            max-height: 180px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .file-input-container {
            margin-top: 5px;
        }

        .path-display {
            margin-top: 5px;
            font-size: 12px;
            color: #555;
            word-break: break-all;
        }

        /* New style for poster storage */
        .poster-storage {
            display: none;
        }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
    <a href="adminDashboard.html" class="logo">FLIXGO ADMIN</a>
    <div class="admin-actions">
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
</header>

<!-- Main Content -->
<div class="container">
    <h1 class="dashboard-title">Movie Management</h1>

    <div class="dashboard-grid">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="adminDashboard.html">Dashboard Overview</a></li>
                <li><a href="adminDashboard.html?section=users">User Management</a></li>
                <li><a href="adminDashboard.html?section=admins">Admin Management</a></li>
                <li><a href="#" class="active">Movie Management</a></li>
                <li><a href="movie.html?adminAccess=true">Movies</a></li>
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <div class="movie-management-section">
                <h2 class="section-title">Movies Catalog</h2>

                <!-- Search and Add Movie -->
                <div class="movie-toolbar">
                    <div class="search-box">
                        <input type="text" id="movieSearch" placeholder="Search movies...">
                        <button class="search-btn" id="searchBtn">Search</button>
                    </div>
                    <button class="btn" id="addMovieBtn">Add New Movie</button>
                </div>

                <!-- Movies Table -->
                <table class="data-table" id="moviesTable">
                    <thead>
                    <tr>
                        <th>Poster</th>
                        <th>Title</th>
                        <th>Year</th>
                        <th>Rating</th>
                        <th>Genre</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="moviesTableBody">
                    <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>

                <!-- Hidden div to store poster image data -->
                <div id="posterStorage" class="poster-storage"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Movie Modal -->
<div class="modal" id="movieModal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 id="modalTitle">Add New Movie</h2>

        <form id="movieForm">
            <input type="hidden" id="movieId">
            <!-- Added hidden field to store base64 image data -->
            <input type="hidden" id="posterBase64" name="posterBase64">

            <div class="form-row">
                <div class="form-group">
                    <label for="movieTitle">Title*</label>
                    <input type="text" id="movieTitle" required>
                </div>

                <div class="form-group">
                    <label for="movieYear">Release Year*</label>
                    <input type="number" id="movieYear" min="1900" max="2030" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="movieRating">Rating* (0.0-10.0)</label>
                    <input type="number" id="movieRating" min="0" max="10" step="0.1" required>
                </div>

                <div class="form-group">
                    <label for="movieGenre">Genre*</label>
                    <select id="movieGenre" required>
                        <option value="">Select Genre</option>
                        <option value="Action">Action</option>
                        <option value="Adventure">Adventure</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Drama">Drama</option>
                        <option value="Horror">Horror</option>
                        <option value="Sci-Fi">Sci-Fi</option>
                        <option value="Thriller">Thriller</option>
                        <option value="Romance">Romance</option>
                        <option value="Animation">Animation</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="movieDescription">Description*</label>
                <textarea id="movieDescription" rows="4" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="moviePoster">Poster Path*</label>
                    <input type="text" id="moviePoster" placeholder="Local path to poster image" required>
                    <small>Example: C:\posters\movie1.jpg</small>

                    <!-- Added file input for image selection -->
                    <div class="file-input-container">
                        <label for="posterFileInput">Select poster image to preview:</label>
                        <input type="file" id="posterFileInput" accept="image/*">
                    </div>

                    <div class="image-preview" id="posterPreview"></div>
                </div>

                <div class="form-group">
                    <label for="movieFile">Movie File Path*</label>
                    <input type="text" id="movieFile" placeholder="Local path to movie file" required>
                    <small>Example: C:\movies\movie1.mp4</small>

                    <!-- Added file input for movie selection -->
                    <div class="file-input-container">
                        <label for="movieFileInput">Select movie file:</label>
                        <input type="file" id="movieFileInput" accept="video/*">
                    </div>
                    <div class="path-display" id="movieFileDisplay"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="movieTrailer">Trailer Path</label>
                <input type="text" id="movieTrailer" placeholder="Local path to trailer file">
                <small>Example: C:\trailers\movie1_trailer.mp4</small>

                <!-- Added file input for trailer selection -->
                <div class="file-input-container">
                    <label for="trailerFileInput">Select trailer file:</label>
                    <input type="file" id="trailerFileInput" accept="video/*">
                </div>
                <div class="path-display" id="trailerFileDisplay"></div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn">Save Movie</button>
                <button type="button" class="btn cancel-btn" id="cancelMovieBtn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="confirmModal">
    <div class="modal-content small-modal">
        <h2>Confirm Action</h2>
        <p id="confirmMessage">Are you sure you want to delete this movie?</p>
        <div class="form-actions">
            <button class="btn" id="confirmYes">Yes</button>
            <button class="btn cancel-btn" id="confirmNo">No</button>
        </div>
    </div>
</div>

<script>
    // Replace the existing script section with this improved version
    document.addEventListener('DOMContentLoaded', function () {
        const moviesTableBody = document.getElementById('moviesTableBody');
        const addMovieBtn = document.getElementById('addMovieBtn');
        const movieModal = document.getElementById('movieModal');
        const confirmModal = document.getElementById('confirmModal');
        const movieForm = document.getElementById('movieForm');
        const posterPreview = document.getElementById('posterPreview');
        const closeBtn = document.querySelector('.close-btn');
        const cancelMovieBtn = document.getElementById('cancelMovieBtn');
        const searchBtn = document.getElementById('searchBtn');
        const movieSearch = document.getElementById('movieSearch');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        const moviePosterInput = document.getElementById('moviePoster');
        const posterFileInput = document.getElementById('posterFileInput');
        const movieFileInput = document.getElementById('movieFileInput');
        const trailerFileInput = document.getElementById('trailerFileInput');
        const movieFileDisplay = document.getElementById('movieFileDisplay');
        const trailerFileDisplay = document.getElementById('trailerFileDisplay');
        const movieFilePathInput = document.getElementById('movieFile');
        const trailerPathInput = document.getElementById('movieTrailer');
        const posterBase64Input = document.getElementById('posterBase64');
        const posterStorage = document.getElementById('posterStorage');

        // Configuration settings
        const CONFIG = {
            MAX_POSTER_SIZE: 5 * 1024 * 1024, // 5MB max poster size
            MAX_POSTER_WIDTH: 800, // Maximum width for resized posters
            MAX_POSTER_HEIGHT: 1200, // Maximum height for resized posters
            POSTER_QUALITY: 0.7 // JPEG quality for compression (0.0 - 1.0)
        };

        let movies = [];
        let currentAction = '';
        let movieToDelete = null;
        let currentPosterImage = null;
        let isProcessingForm = false; // Flag to prevent multiple submissions

        // Load and initialize stored posters from localStorage
        initializePosterStorage();

        fetchMovies();
        setupEventListeners();

        function setupEventListeners() {
            addMovieBtn.addEventListener('click', () => showMovieModal('add'));
            closeBtn.addEventListener('click', () => movieModal.style.display = 'none');
            cancelMovieBtn.addEventListener('click', () => movieModal.style.display = 'none');
            movieForm.addEventListener('submit', handleMovieSubmit);

            moviePosterInput.addEventListener('change', function() {
                if (!posterFileInput.files.length) {
                    updatePosterPath();
                }
            });

            confirmYes.addEventListener('click', confirmAction);
            confirmNo.addEventListener('click', () => confirmModal.style.display = 'none');
            searchBtn.addEventListener('click', fetchMovies);
            movieSearch.addEventListener('keypress', e => {
                if (e.key === 'Enter') fetchMovies();
            });
            document.getElementById('logoutBtn').addEventListener('click', logoutAdmin);

            // File input event listeners
            posterFileInput.addEventListener('change', handlePosterFileSelect);
            movieFileInput.addEventListener('change', function() {
                handleFileSelect(this, movieFilePathInput, movieFileDisplay);
            });
            trailerFileInput.addEventListener('change', function() {
                handleFileSelect(this, trailerPathInput, trailerFileDisplay);
            });
        }

        // Initialize poster storage from local storage
        function initializePosterStorage() {
            const storedPosters = localStorage.getItem('moviePosters');
            if (storedPosters) {
                try {
                    const posters = JSON.parse(storedPosters);
                    Object.keys(posters).forEach(id => {
                        const img = document.createElement('img');
                        img.src = posters[id];
                        img.id = `poster-${id}`;
                        img.style.display = 'none';
                        posterStorage.appendChild(img);
                    });
                } catch (e) {
                    console.error('Error loading stored posters:', e);
                    localStorage.removeItem('moviePosters');
                }
            }
        }

        // Save poster to storage
        function savePosterToStorage(id, base64Data) {
            try {
                let posters = {};
                const storedPosters = localStorage.getItem('moviePosters');
                if (storedPosters) {
                    try {
                        posters = JSON.parse(storedPosters);
                    } catch (e) {
                        console.error('Error parsing stored posters:', e);
                    }
                }

                posters[id] = base64Data;
                localStorage.setItem('moviePosters', JSON.stringify(posters));

                // Add to DOM storage as well
                let img = document.getElementById(`poster-${id}`);
                if (!img) {
                    img = document.createElement('img');
                    img.id = `poster-${id}`;
                    img.style.display = 'none';
                    posterStorage.appendChild(img);
                }
                img.src = base64Data;
                return true;
            } catch (e) {
                console.error('Error saving poster to storage:', e);
                alert('Failed to save poster image. The image may be too large.');
                return false;
            }
        }

        // Get poster from storage
        function getPosterFromStorage(id) {
            // First check DOM storage
            const img = document.getElementById(`poster-${id}`);
            if (img) {
                return img.src;
            }

            // Then check localStorage
            const storedPosters = localStorage.getItem('moviePosters');
            if (storedPosters) {
                try {
                    const posters = JSON.parse(storedPosters);
                    return posters[id] || null;
                } catch (e) {
                    console.error('Error getting poster from storage:', e);
                }
            }
            return null;
        }

        // Compress and resize image before converting to base64
        function compressImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                if (!file || file.type.indexOf('image/') !== 0) {
                    reject(new Error('Not a valid image file'));
                    return;
                }

                // Show a loading indicator
                posterPreview.innerHTML = '<p>Processing image...</p>';

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        // Calculate new dimensions while maintaining aspect ratio
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }

                        // Create canvas and context
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // Draw and compress the image
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to compressed data URL
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.onerror = function() {
                        reject(new Error('Error loading image'));
                    };
                };
                reader.onerror = function() {
                    reject(new Error('Error reading file'));
                };
            });
        }

        // Updated handlePosterFileSelect function with file size check and compression
        function handlePosterFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                posterPreview.innerHTML = '';
                currentPosterImage = null;
                posterBase64Input.value = '';
                return;
            }

            // Check file size
            if (file.size > CONFIG.MAX_POSTER_SIZE) {
                alert(`File is too large. Maximum size is ${CONFIG.MAX_POSTER_SIZE / (1024 * 1024)}MB.`);
                event.target.value = ''; // Clear the file input
                return;
            }

            // Update the path input
            moviePosterInput.value = file.name;

            // Compress and preview the image
            compressImage(file, CONFIG.MAX_POSTER_WIDTH, CONFIG.MAX_POSTER_HEIGHT, CONFIG.POSTER_QUALITY)
                .then(dataUrl => {
                    posterPreview.innerHTML = `<img src="${dataUrl}" alt="Poster Preview">`;
                    currentPosterImage = dataUrl;
                    posterBase64Input.value = dataUrl;
                })
                .catch(error => {
                    console.error('Image compression error:', error);
                    posterPreview.innerHTML = '<p>Error processing image</p>';
                    alert('Error processing image: ' + error.message);
                });
        }

        // Handle file selection for other files (movie, trailer)
        function handleFileSelect(fileInput, pathInput, displayElement) {
            const file = fileInput.files[0];
            if (file) {
                pathInput.value = file.name;
                displayElement.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Updated updatePosterPath function
        function updatePosterPath() {
            const path = moviePosterInput.value.trim();
            if (path && !currentPosterImage) {
                const img = new Image();
                img.onload = function() {
                    posterPreview.innerHTML = `<img src="${path}" alt="Poster Preview">`;
                };
                img.onerror = function() {
                    const filename = getFilenameFromPath(path);
                    posterPreview.innerHTML = `
                <div class="placeholder-poster">
                    <p>${filename}</p>
                    <p><small>(No preview available)</small></p>
                </div>`;
                };
                img.src = path;
            } else if (!path) {
                posterPreview.innerHTML = '';
            }
        }

        // Helper function to extract filename from path
        function getFilenameFromPath(path) {
            if (!path) return 'No file selected';
            return path.split('\\').pop().split('/').pop();
        }

        function fetchMovies() {
            const searchTerm = movieSearch.value.trim();
            let url = '/api/movies';
            if (searchTerm) {
                url += `?search=${encodeURIComponent(searchTerm)}`;
            }

            fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch movies');
                    return res.json();
                })
                .then(data => {
                    movies = data;
                    renderMovies();
                })
                .catch(err => {
                    console.error('Error fetching movies:', err);
                    moviesTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #e74c3c;">Error loading movies. Please try again.</td></tr>`;
                });
        }

        function renderMovies() {
            if (movies.length === 0) {
                moviesTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No movies found</td></tr>`;
            } else {
                moviesTableBody.innerHTML = movies.map(movie => {
                    const posterFilename = getFilenameFromPath(movie.posterPath || '');

                    // Try to get poster from storage first
                    const storedPoster = getPosterFromStorage(movie.id);

                    // Create poster element - either stored image, or placeholder
                    let posterElement = '';
                    if (storedPoster) {
                        // Use stored base64 image
                        posterElement = `<img src="${storedPoster}" alt="${movie.title}" class="table-poster">`;
                    } else if (movie.posterPath) {
                        // Fallback to path and default image on error
                        posterElement = `<img src="${movie.posterPath}" alt="${movie.title}" class="table-poster" onerror="this.onerror=null; this.src='img/default-movie.jpg'; this.alt='Image not found'">`;
                    } else {
                        // Fallback to placeholder with text
                        posterElement = `<div class="placeholder-poster">${posterFilename || 'No poster'}</div>`;
                    }

                    return `
                <tr data-id="${movie.id}">
                    <td>${posterElement}</td>
                    <td>${movie.title}</td>
                    <td>${movie.year}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.genre}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editMovie('${movie.id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteMovie('${movie.id}')">Delete</button>
                    </td>
                </tr>
            `;
                }).join('');
            }
        }

        window.editMovie = function (movieId) {
            showMovieModal('edit', movieId);
        };

        window.deleteMovie = function (movieId) {
            showDeleteConfirm(movieId);
        };

        // Updated showMovieModal function
        function showMovieModal(action, movieId = null) {
            currentAction = action;
            document.getElementById('modalTitle').textContent = action === 'add' ? 'Add New Movie' : 'Edit Movie';

            // Reset file inputs
            posterFileInput.value = '';
            movieFileInput.value = '';
            trailerFileInput.value = '';
            currentPosterImage = null;
            movieFileDisplay.textContent = '';
            trailerFileDisplay.textContent = '';
            posterPreview.innerHTML = ''; // Clear poster preview
            posterBase64Input.value = ''; // Clear stored base64 data
            isProcessingForm = false; // Reset form processing flag

            if (action === 'add') {
                movieForm.reset();
                document.getElementById('movieId').value = '';
            } else {
                const movie = movies.find(m => m.id === movieId);
                if (movie) {
                    document.getElementById('movieId').value = movie.id;
                    document.getElementById('movieTitle').value = movie.title;
                    document.getElementById('movieYear').value = movie.year;
                    document.getElementById('movieRating').value = movie.rating;
                    document.getElementById('movieGenre').value = movie.genre;
                    document.getElementById('movieDescription').value = movie.description;
                    document.getElementById('moviePoster').value = movie.posterPath;
                    document.getElementById('movieFile').value = movie.filePath;
                    document.getElementById('movieTrailer').value = movie.trailerPath || '';

                    // Check for stored poster
                    const storedPoster = getPosterFromStorage(movie.id);
                    if (storedPoster) {
                        posterPreview.innerHTML = `<img src="${storedPoster}" alt="Poster Preview">`;
                        currentPosterImage = storedPoster;
                        posterBase64Input.value = storedPoster;
                    } else if (movie.posterPath) {
                        // Show placeholder for poster
                        const filename = getFilenameFromPath(movie.posterPath);
                        posterPreview.innerHTML = `
                        <div class="placeholder-poster">
                            <p>${filename}</p>
                            <p><small>(No preview available)</small></p>
                        </div>`;
                    }

                    // Show filenames for movie and trailer
                    if (movie.filePath) {
                        movieFileDisplay.textContent = `File: ${getFilenameFromPath(movie.filePath)}`;
                    }

                    if (movie.trailerPath) {
                        trailerFileDisplay.textContent = `File: ${getFilenameFromPath(movie.trailerPath)}`;
                    }
                }
            }

            movieModal.style.display = 'block';
        }

        // Updated handleMovieSubmit function with form submission protection
        function handleMovieSubmit(e) {
            e.preventDefault();

            // Prevent multiple submissions
            if (isProcessingForm) {
                console.log('Form submission already in progress');
                return;
            }

            isProcessingForm = true;

            // Show processing indicator
            const submitBtn = document.querySelector('#movieForm button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;

            const movieId = document.getElementById('movieId').value;
            const movieData = {
                title: document.getElementById('movieTitle').value.trim(),
                year: parseInt(document.getElementById('movieYear').value),
                rating: parseFloat(document.getElementById('movieRating').value),
                genre: document.getElementById('movieGenre').value,
                description: document.getElementById('movieDescription').value.trim(),
                posterPath: document.getElementById('moviePoster').value.trim(),
                filePath: document.getElementById('movieFile').value.trim(),
                trailerPath: document.getElementById('movieTrailer').value.trim() || null
            };

            let url = '/api/movies';
            let method = 'POST';
            let newId = null;

            if (currentAction === 'edit' && movieId) {
                url += `/${movieId}`;
                method = 'PUT';
                movieData.id = movieId;
                newId = movieId;
            }

            // Store poster base64 data if available - but do this before the fetch
            let posterStorageSuccess = true;
            if (posterBase64Input.value) {
                if (!newId) {
                    // For new movies, generate a temporary ID
                    newId = 'temp-' + Date.now();
                }
                // Store the poster image data
                posterStorageSuccess = savePosterToStorage(newId, posterBase64Input.value);

                if (!posterStorageSuccess) {
                    // Reset form state
                    isProcessingForm = false;
                    submitBtn.textContent = originalBtnText;
                    submitBtn.disabled = false;
                    return; // Don't proceed with the fetch
                }
            }

            fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(movieData),
                credentials: 'include'
            })
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to ${currentAction} movie`);
                    return res.json();
                })
                .then((data) => {
                    // If we stored the poster with a temporary ID, update it to the real ID
                    if (newId && newId.startsWith('temp-') && posterBase64Input.value) {
                        const newRealId = data.id; // Get the real ID from the response
                        const storedImage = getPosterFromStorage(newId);
                        if (storedImage) {
                            savePosterToStorage(newRealId, storedImage);

                            // Remove the temporary poster
                            let posters = {};
                            const storedPosters = localStorage.getItem('moviePosters');
                            if (storedPosters) {
                                posters = JSON.parse(storedPosters);
                                delete posters[newId];
                                localStorage.setItem('moviePosters', JSON.stringify(posters));
                            }

                            const tempImg = document.getElementById(`poster-${newId}`);
                            if (tempImg) {
                                posterStorage.removeChild(tempImg);
                            }
                        }
                    }

                    movieModal.style.display = 'none';
                    // Add delay before refreshing the table to ensure server has processed the request
                    setTimeout(fetchMovies, 500);
                    alert(`Movie ${currentAction === 'add' ? 'added' : 'updated'} successfully!`);
                })
                .catch(err => {
                    console.error(`Error ${currentAction}ing movie:`, err);
                    alert(err.message || `Failed to ${currentAction} movie. Please try again.`);
                })
                .finally(() => {
                    // Reset form state
                    isProcessingForm = false;
                    submitBtn.textContent = originalBtnText;
                    submitBtn.disabled = false;
                });
        }

        function showDeleteConfirm(movieId) {
            currentAction = 'delete';
            movieToDelete = movieId;

            const movie = movies.find(m => m.id === movieId);
            if (movie) {
                document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${movie.title}"?`;
                confirmModal.style.display = 'block';
            }
        }

        function confirmAction() {
            if (currentAction === 'delete' && movieToDelete) {
                fetch(`/api/movies/${movieToDelete}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to delete movie');
                        return res.json();
                    })
                    .then(() => {
                        confirmModal.style.display = 'none';

                        // Remove poster from storage
                        const storedPosters = localStorage.getItem('moviePosters');
                        if (storedPosters) {
                            const posters = JSON.parse(storedPosters);
                            if (posters[movieToDelete]) {
                                delete posters[movieToDelete];
                                localStorage.setItem('moviePosters', JSON.stringify(posters));
                            }
                        }

                        // Remove from DOM storage
                        const img = document.getElementById(`poster-${movieToDelete}`);
                        if (img) {
                            posterStorage.removeChild(img);
                        }

                        // Add delay before refreshing the table
                        setTimeout(fetchMovies, 500);
                        alert('Movie deleted successfully!');
                    })
                    .catch(err => {
                        console.error('Error deleting movie:', err);
                        alert('Failed to delete movie. Please try again.');
                    });
            }
        }

        function logoutAdmin() {
            if (confirm("Are you sure you want to logout?")) {
                fetch('/admin-logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                    .then(res => {
                        if (res.ok) {
                            window.location.href = 'adminLogin.html';
                        } else {
                            throw new Error('Logout failed');
                        }
                    })
                    .catch(err => {
                        console.error('Logout error:', err);
                        alert('Logout failed. Please try again.');
                    });
            }
        }
    });
</script>
</body>
</html>