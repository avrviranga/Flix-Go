<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLIXGO - Movie Reviews</title>
    <link rel="icon" type="image/png" href="assets/favicon-32x32.png">
    <link rel="stylesheet" href="css/UserDashboard.css">
    <link rel="stylesheet" href="css/ReviewPage.css">
    <style>
        /* Override styles to match UserDashboard dark theme */
        body {
            color: white;
            background-color: #141414;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }

        .content-area {
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 2rem;
        }

        .dashboard-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e50914;
        }

        .section-title {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: #e50914;
        }

        /* Review specific styles */
        .movie-selection {
            margin-bottom: 2rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .search-box input {
            flex: 1;
            padding: 0.75rem 1rem;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-size: 1rem;
        }

        .search-box input:focus {
            border-color: #e50914;
            outline: none;
        }

        .movie-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .movie-item {
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .movie-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .movie-info {
            padding: 1rem 0;
        }

        .movie-info h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .review-btn {
            background-color: #e50914;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }

        .review-btn:hover {
            background-color: #f40612;
        }

        /* Review Form Section */
        .review-form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
        }

        .selected-movie-card {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #444;
        }

        .selected-movie-card h3 {
            margin-bottom: 0.5rem;
        }

        .star-rating {
            font-size: 2rem;
            color: #888;
            margin: 0.5rem 0;
            cursor: pointer;
        }

        .star-rating .star {
            transition: color 0.2s ease;
        }

        .star-rating .star.hover,
        .star-rating .star.active {
            color: #e50914;
        }

        .review-form textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
        }

        .review-form textarea:focus {
            border-color: #e50914;
            outline: none;
        }

        /* My Reviews Section */
        .my-reviews {
            margin-top: 2rem;
        }

        .reviews-list {
            margin-top: 1.5rem;
        }

        .review-item {
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-movie {
            margin-bottom: 1rem;
        }

        .review-rating {
            color: #e50914;
            font-size: 1.2rem;
            margin: 0.5rem 0;
        }

        .review-rating span {
            font-size: 1rem;
            color: #fff;
            margin-left: 0.5rem;
        }

        .review-date {
            color: #888;
            font-size: 0.9rem;
        }

        .review-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .edit-review-btn,
        .delete-review-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }

        .edit-review-btn {
            background-color: #6c757d;
            color: white;
        }

        .delete-review-btn {
            background-color: #dc3545;
            color: white;
        }

        /* Debug info box */
        .debug-info-box {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #444;
            font-size: 14px;
        }

        .debug-info-label {
            color: #e50914;
            font-weight: 500;
        }

        .debug-info-value {
            font-family: monospace;
            color: #fff;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
    <a href="index.html" class="logo">FLIXGO</a>

    <nav class="nav-links">
        <a href="UserDashboard.html">Home</a>
        <a href="movie.html">Movies</a>
        <a href="Ticketpage.html">My Tickets</a>
    </nav>

    <div class="user-actions">
        <div class="user-avatar" id="userAvatar">U</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
</header>

<!-- Main Content -->
<div class="container">
    <div class="dashboard-grid">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="UserDashboard.html">Account Details</a></li>
                <li><a href="WatchedHistory.html">Watched History</a></li>
                <li><a href="ReviewPage.html" class="active">My Reviews</a></li>
                <li><a href="PaymentMethods.html">Payment Methods</a></li>
                <li><a href="Ticketpage.html">Ticket</a></li>
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <h1 class="dashboard-title">Movie Reviews</h1>

            <!-- Debug info - can be removed in production -->
            <div id="debugInfo" class="debug-info-box" style="display: none;">
                <span class="debug-info-label">User Email:</span>
                <span id="currentUserEmail" class="debug-info-value">Not set</span>
            </div>

            <!-- Error message container -->
            <div class="error-message" id="errorMessage" style="display: none;"></div>

            <!-- Success message container -->
            <div class="success-message" id="successMessage" style="display: none;"></div>

            <!-- Movie Selection Section -->
            <div class="movie-selection">
                <h2 class="section-title">Select a Movie to Review</h2>
                <div class="search-box">
                    <input type="text" id="movieSearch" placeholder="Search for a movie...">
                    <button class="btn" id="searchBtn">Search</button>
                </div>

                <div class="movie-list" id="movieList">
                    <!-- Movie items will be populated here by JavaScript -->
                    <div class="no-results" style="display: none;">No movies found matching your search.</div>
                </div>
            </div>

            <!-- Review Form Section -->
            <div class="review-form-section" id="reviewFormSection" style="display: none;">
                <h2 class="section-title" id="reviewFormTitle">Write Your Review</h2>
                <div class="selected-movie" id="selectedMovieInfo">
                    <!-- Selected movie info will be populated here -->
                </div>

                <form class="review-form" id="reviewForm">
                    <div class="form-group">
                        <label for="rating">Rating (1-5 stars)</label>
                        <div class="star-rating">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                            <input type="hidden" id="rating" name="rating" value="0">
                        </div>
                        <div class="field-error" id="ratingError"></div>
                    </div>

                    <div class="form-group">
                        <label for="reviewText">Your Review</label>
                        <textarea id="reviewText" name="reviewText" rows="5" placeholder="Share your thoughts about the movie..."></textarea>
                        <div class="field-error" id="reviewTextError"></div>
                    </div>

                    <div>
                        <button type="button" class="btn btn-secondary" id="cancelReviewBtn">Cancel</button>
                        <button type="submit" class="btn" id="submitReviewBtn">Submit Review</button>
                    </div>
                </form>
            </div>

            <!-- My Reviews Section -->
            <div class="my-reviews">
                <h2 class="section-title">My Reviews</h2>
                <div class="reviews-list" id="reviewsList">
                    <!-- User's reviews will be populated here -->
                    <div class="no-reviews" id="noReviewsMessage">
                        You haven't submitted any reviews yet.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const movieSearch = document.getElementById('movieSearch');
        const searchBtn = document.getElementById('searchBtn');
        const movieList = document.getElementById('movieList');
        const reviewFormSection = document.getElementById('reviewFormSection');
        const selectedMovieInfo = document.getElementById('selectedMovieInfo');
        const reviewForm = document.getElementById('reviewForm');
        const ratingInput = document.getElementById('rating');
        const stars = document.querySelectorAll('.star');
        const reviewsList = document.getElementById('reviewsList');
        const noReviewsMessage = document.getElementById('noReviewsMessage');
        const cancelReviewBtn = document.getElementById('cancelReviewBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const debugInfo = document.getElementById('debugInfo');
        const currentUserEmail = document.getElementById('currentUserEmail');
        const reviewFormTitle = document.getElementById('reviewFormTitle');
        const submitReviewBtn = document.getElementById('submitReviewBtn');

        // For development purposes - set to true to enable debugging
        const DEBUG_MODE = true;
        if (DEBUG_MODE) debugInfo.style.display = 'block';

        // Current selected movie and review
        let selectedMovie = null;
        let editingReviewId = null;
        let userEmail = null;

        // Initialize the page
        loadUserData();

        // Event listeners
        searchBtn.addEventListener('click', searchMovies);
        movieSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchMovies();
        });

        cancelReviewBtn.addEventListener('click', function() {
            reviewFormSection.style.display = 'none';
            clearReviewForm();
            editingReviewId = null;
        });

        logoutBtn.addEventListener('click', function() {
            logoutUser();
        });

        // Star rating functionality
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                ratingInput.value = value;

                // Update star display
                stars.forEach((s, index) => {
                    if (index < value) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });

            star.addEventListener('mouseover', function() {
                const value = parseInt(this.getAttribute('data-value'));

                stars.forEach((s, index) => {
                    if (index < value) {
                        s.classList.add('hover');
                    } else {
                        s.classList.remove('hover');
                    }
                });
            });

            star.addEventListener('mouseout', function() {
                stars.forEach(s => s.classList.remove('hover'));
            });
        });

        // Form submission
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview();
        });

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch('user-data', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }

                const userData = await response.json();
                userEmail = userData.email;
                sessionStorage.setItem('userEmail', userEmail);

                if (DEBUG_MODE) currentUserEmail.textContent = userEmail;

                // Set avatar initial
                if (userData.fullName) {
                    userAvatar.textContent = userData.fullName.charAt(0).toUpperCase();
                }

                // Load user reviews
                loadUserReviews();

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user data. Please try again.');

                // Still try to load reviews if we have an email
                if (userEmail) {
                    loadUserReviews();
                }
            }
        }

        // Logout user
        async function logoutUser() {
            try {
                const response = await fetch('logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Clear client-side data
                    localStorage.removeItem('userEmail');
                    sessionStorage.removeItem('userEmail');
                    userEmail = null;

                    // Redirect to login with success state
                    window.location.href = 'login.html?logout=success';
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showError('Logout failed. Please try again.');
            }
        }

        // Search movies
        async function searchMovies() {
            const query = movieSearch.value.trim();

            if (!query) {
                showError('Please enter a search term');
                return;
            }

            try {
                const response = await fetch(`/api/reviews?query=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch movies');
                }

                const movies = await response.json();
                displayMovies(movies);
            } catch (error) {
                console.error('Error searching movies:', error);
                showError('Failed to search movies. Please try again.');
            }
        }

        // Display movies in search results (only movie names)
        function displayMovies(movies) {
            movieList.innerHTML = '';

            if (movies.length === 0) {
                movieList.innerHTML = '<div class="no-results">No movies found matching your search.</div>';
                return;
            }

            movies.forEach(movie => {
                const movieItem = document.createElement('div');
                movieItem.className = 'movie-item';
                movieItem.innerHTML = `
                    <div class="movie-info">
                        <h3>${movie.title} (${movie.year || 'N/A'})</h3>
                        <button class="btn review-btn" data-movie-id="${movie.id}">Write Review</button>
                    </div>
                `;

                movieList.appendChild(movieItem);
            });

            // Add event listeners to review buttons
            document.querySelectorAll('.review-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const movieId = this.getAttribute('data-movie-id');
                    const movie = movies.find(m => m.id === movieId);
                    if (movie) {
                        startNewReview(movie);
                    }
                });
            });
        }

        // Start a new review for selected movie
        function startNewReview(movie) {
            editingReviewId = null;
            selectedMovie = movie;
            reviewFormTitle.textContent = 'Write Your Review';
            submitReviewBtn.textContent = 'Submit Review';

            // Display selected movie info (without poster)
            selectedMovieInfo.innerHTML = `
                <div class="selected-movie-card">
                    <div>
                        <h3>${movie.title} (${movie.year || 'N/A'})</h3>
                        <p>Now writing your review...</p>
                    </div>
                </div>
            `;

            // Show the review form
            reviewFormSection.style.display = 'block';
            reviewFormSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Submit review (create or update)
        async function submitReview() {
            const rating = parseInt(ratingInput.value);
            const reviewText = document.getElementById('reviewText').value.trim();

            // Validate form
            if (!rating || rating < 1 || rating > 5) {
                document.getElementById('ratingError').textContent = 'Please select a rating';
                document.getElementById('ratingError').style.display = 'block';
                return;
            }

            if (!reviewText) {
                document.getElementById('reviewTextError').textContent = 'Please write your review';
                document.getElementById('reviewTextError').style.display = 'block';
                return;
            }

            if (!userEmail) {
                showError('User email not found. Please log in again.');
                return;
            }

            try {
                // Create review object
                const review = {
                    id: editingReviewId || undefined,
                    userEmail: userEmail,
                    movieId: selectedMovie.id,
                    movieTitle: selectedMovie.title,
                    rating: rating,
                    reviewText: reviewText
                };

                const method = editingReviewId ? 'PUT' : 'POST';
                const response = await fetch('/api/reviews', {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(review)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to submit review');
                }

                // Show success message
                showSuccess(`Review ${editingReviewId ? 'updated' : 'submitted'} successfully!`);

                // Reset form and state
                clearReviewForm();
                reviewFormSection.style.display = 'none';
                editingReviewId = null;

                // Reload user reviews
                loadUserReviews();

            } catch (error) {
                console.error('Error submitting review:', error);
                showError(error.message || 'Failed to submit review. Please try again.');
            }
        }

        // Load user's reviews
        async function loadUserReviews() {
            if (!userEmail) {
                showError('User email not found. Please log in again.');
                return;
            }

            try {
                const response = await fetch(`/api/reviews?userEmail=${encodeURIComponent(userEmail)}`);
                if (!response.ok) {
                    throw new Error('Failed to load reviews');
                }

                const reviews = await response.json();
                displayUserReviews(reviews);
            } catch (error) {
                console.error('Error loading user reviews:', error);
                showError('Failed to load your reviews. Please try again.');
            }
        }

        // Display user's reviews (without posters)
        function displayUserReviews(reviews) {
            reviewsList.innerHTML = '';

            if (reviews.length === 0) {
                noReviewsMessage.style.display = 'block';
                return;
            }

            noReviewsMessage.style.display = 'none';

            reviews.forEach(review => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';

                reviewItem.innerHTML = `
                    <div class="review-movie">
                        <h3>${review.movieTitle}</h3>
                        <div class="review-rating">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                            <span>${review.rating}/5</span>
                        </div>
                        <div class="review-date">${formatDate(review.date)}</div>
                    </div>
                    <div class="review-content">
                        <p>${review.reviewText}</p>
                        <button class="btn btn-secondary edit-review-btn" data-review-id="${review.id}">Edit</button>
                        <button class="btn btn-danger delete-review-btn" data-review-id="${review.id}">Delete</button>
                    </div>
                `;

                reviewsList.appendChild(reviewItem);
            });

            // Add event listeners to edit/delete buttons
            document.querySelectorAll('.edit-review-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    editReview(reviewId);
                });
            });

            document.querySelectorAll('.delete-review-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    deleteReview(reviewId);
                });
            });
        }

        // Edit existing review
        async function editReview(reviewId) {
            try {
                editingReviewId = reviewId;

                // Fetch the review details
                const response = await fetch(`/api/reviews/${reviewId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch review details');
                }

                const review = await response.json();
                if (!review) {
                    throw new Error('Review not found');
                }

                // Update form title and button
                reviewFormTitle.textContent = 'Edit Your Review';
                submitReviewBtn.textContent = 'Update Review';

                // Create a minimal movie object from the review data
                selectedMovie = {
                    id: review.movieId,
                    title: review.movieTitle,
                    year: ''
                };

                // Display selected movie info (without poster)
                selectedMovieInfo.innerHTML = `
                    <div class="selected-movie-card">
                        <div>
                            <h3>${selectedMovie.title}</h3>
                            <p>Editing your review...</p>
                        </div>
                    </div>
                `;

                // Fill the form with existing review data
                ratingInput.value = review.rating;
                document.getElementById('reviewText').value = review.reviewText;

                // Update star display
                stars.forEach((s, index) => {
                    if (index < review.rating) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });

                // Show the review form
                reviewFormSection.style.display = 'block';
                reviewFormSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error fetching review:', error);
                showError(error.message || 'Failed to load review for editing. Please try again.');
            }
        }

        // Delete review
        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) {
                return;
            }

            try {
                const response = await fetch(`/api/reviews?id=${reviewId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete review');
                }

                // Reload reviews
                loadUserReviews();
                showSuccess('Review deleted successfully.');

            } catch (error) {
                console.error('Error deleting review:', error);
                showError(error.message || 'Failed to delete review. Please try again.');
            }
        }

        // Format date for display
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString || 'Unknown date';
            }
        }

        // Clear review form
        function clearReviewForm() {
            ratingInput.value = '0';
            document.getElementById('reviewText').value = '';
            stars.forEach(star => star.classList.remove('active'));
            document.querySelectorAll('.field-error').forEach(el => {
                el.style.display = 'none';
            });
        }

        // Show success message
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    });
</script>
</body>
</html>