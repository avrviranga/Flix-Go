<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLIXGO - Payment Methods</title>
    <link rel="icon" type="image/png" href="assets/favicon-32x32.png">
    <link rel="stylesheet" href="css/PaymentMethods.css">
</head>
<body>
<!-- Header -->
<header class="header">
    <a href="index.html" class="logo">FLIXGO</a>

    <nav class="nav-links">
        <a href="UserDashboard.html">Home</a>
        <a href="movie.html">Movies</a>
        <a href="Ticketpage.html">My Tickets</a>
    </nav>

    <div class="user-actions">
        <div class="user-avatar" id="userAvatar">U</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
</header>

<!-- Main Content -->
<div class="container">
    <h1 class="dashboard-title">My Account</h1>

    <div class="dashboard-grid">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="UserDashboard.html">Account Details</a></li>
                <li><a href="WatchedHistory.html">Watched History</a></li>
                <li><a href="ReviewPage.html">My Reviews</a></li>
                <li><a href="#" class="active">Payment Methods</a></li>
                <li><a href="Ticketpage.html">Ticket</a></li>
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>

            <h2 class="section-title">Payment Methods</h2>

            <div id="paymentMethodsContainer">
                <!-- This will be populated dynamically -->
                <div class="no-methods-message" id="noMethodsMessage" style="display: none;">
                    <p>You don't have any payment methods saved yet.</p>
                </div>

                <!-- Existing payment method example -->
                <div class="payment-method-box" id="existingCardSection" style="display: none;">
                    <div class="payment-method-header">
                        <span class="card-icon">ðŸ’³</span>
                        <h3>VISA â€¢â€¢â€¢â€¢ <span class="last-four" id="lastFour">1234</span></h3>
                    </div>
                    <div class="card-details">
                        <p>Expires: <span id="existingExpiry">MM/YY</span></p>
                        <p>Card holder: <span id="existingCardHolder">John Doe</span></p>
                    </div>
                    <div class="payment-method-actions">
                        <button class="btn btn-secondary" id="editCardBtn">Edit Card</button>
                        <button class="btn btn-danger" id="removeCardBtn">Remove</button>
                    </div>
                </div>
            </div>

            <!-- Add New Payment Method Form -->
            <h3 class="section-title" id="addCardTitle">Add Payment Method</h3>
            <form class="account-form" id="paymentForm">
                <input type="hidden" id="userEmail" name="userEmail" value="">

                <div class="form-group">
                    <label for="cardNumber">Card Number</label>
                    <input type="text" id="cardNumber" name="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required>
                    <div class="field-error" id="cardNumberError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="text" id="expiryDate" name="expiryDate" placeholder="MM/YY" maxlength="5" required>
                        <div class="field-error" id="expiryDateError"></div>
                    </div>

                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" name="cvv" placeholder="XXX" maxlength="3" required>
                        <div class="field-error" id="cvvError"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cardHolder">Cardholder Name</label>
                    <input type="text" id="cardHolder" name="cardHolder" placeholder="Name as it appears on card" required>
                    <div class="field-error" id="cardHolderError"></div>
                </div>

                <div>
                    <button type="button" class="btn btn-secondary" id="cancelCardBtn">Cancel</button>
                    <button type="submit" class="btn" id="saveCardBtn">Save Card</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const paymentForm = document.getElementById('paymentForm');
        const existingCardSection = document.getElementById('existingCardSection');
        const noMethodsMessage = document.getElementById('noMethodsMessage');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const editCardBtn = document.getElementById('editCardBtn');
        const removeCardBtn = document.getElementById('removeCardBtn');
        const cancelCardBtn = document.getElementById('cancelCardBtn');
        const addCardTitle = document.getElementById('addCardTitle');
        const userEmailInput = document.getElementById('userEmail');

        // Load user data when page loads
        loadUserData();
        loadPaymentMethods();

        // Form input formatting
        const cardNumberInput = document.getElementById('cardNumber');
        const expiryDateInput = document.getElementById('expiryDate');
        const cvvInput = document.getElementById('cvv');

        // Format card number with spaces
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            let formattedValue = '';

            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }

            e.target.value = formattedValue;
        });

        // Format expiry date with slash
        expiryDateInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }

            e.target.value = value;
        });

        // Only allow numbers in CVV
        cvvInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Form submission handler
        paymentForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (validatePaymentForm()) {
                await savePaymentMethod();
            }
        });

        // Edit card button handler
        editCardBtn.addEventListener('click', function() {
            fillFormWithExistingCardData();
            addCardTitle.textContent = "Edit Payment Method";
            window.scrollTo(0, paymentForm.offsetTop - 100);
        });

        // Remove card button handler
        removeCardBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to remove this payment method?')) {
                removePaymentMethod();
            }
        });

        // Cancel button handler
        cancelCardBtn.addEventListener('click', function() {
            resetForm();
            addCardTitle.textContent = "Add Payment Method";
        });

        // Logout button handler
        logoutBtn.addEventListener('click', function() {
            logoutUser();
        });

        // Load user data from backend
        async function loadUserData() {
            try {
                const response = await fetch('user-data', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }

                const userData = await response.json();

                // Set avatar initial
                userAvatar.textContent = userData.fullName.charAt(0).toUpperCase();
                // Set user email
                userEmailInput.value = userData.email;

                // Only load payment methods after user data is loaded
                await loadPaymentMethods();

            } catch (error) {
                console.error('Error loading user data:', error);
                if (error.message.includes('Unauthorized')) {
                    window.location.href = 'login.html';
                }
            }
        }

        // Load payment methods
        async function loadPaymentMethods() {
            try {
                const email = userEmailInput.value;
                if (!email) {
                    console.error('No email available for loading payment methods');
                    showError('User email not found. Please try logging out and back in.');
                    return;
                }

                console.log('Loading payment methods for email:', email);

                const response = await fetch('payment-methods?email=' + encodeURIComponent(email), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch payment methods: ' + response.status);
                }

                const paymentData = await response.json();
                console.log('Payment data received:', paymentData);

                if (paymentData && paymentData.cardNumber) {
                    // Display existing card info
                    const lastFour = paymentData.cardNumber.slice(-4);
                    document.getElementById('lastFour').textContent = lastFour;
                    document.getElementById('existingExpiry').textContent = paymentData.expiryDate;
                    document.getElementById('existingCardHolder').textContent = paymentData.cardHolder;

                    existingCardSection.style.display = 'block';
                    noMethodsMessage.style.display = 'none';
                } else {
                    // Show no methods message
                    existingCardSection.style.display = 'none';
                    noMethodsMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading payment methods:', error);
                showError('Failed to load payment methods: ' + error.message);
            }
        }

        // Validate payment form
        function validatePaymentForm() {
            clearFieldErrors();
            let isValid = true;

            const cardNumber = cardNumberInput.value.replace(/\s/g, '');
            const expiry = expiryDateInput.value;
            const cvv = cvvInput.value;
            const cardHolder = document.getElementById('cardHolder').value;

            // Validate card number (must be 16 digits)
            if (!cardNumber || cardNumber.length !== 16 || !/^\d+$/.test(cardNumber)) {
                showFieldError('cardNumberError', 'Please enter a valid card number (16 digits)');
                isValid = false;
            }

            // Validate expiry date (must be in format MM/YY and not expired)
            if (!expiry || !expiry.match(/^(0[1-9]|1[0-2])\/\d{2}$/)) {
                showFieldError('expiryDateError', 'Please enter a valid expiry date (MM/YY)');
                isValid = false;
            } else {
                // Check if card is expired
                const [month, year] = expiry.split('/');
                const expiryDate = new Date(2000 + parseInt(year), parseInt(month) - 1, 1);
                const today = new Date();

                if (expiryDate < today) {
                    showFieldError('expiryDateError', 'Card has expired');
                    isValid = false;
                }
            }

            // Validate CVV (must be 3 digits)
            if (!cvv || cvv.length !== 3 || !/^\d{3}$/.test(cvv)) {
                showFieldError('cvvError', 'Please enter a valid 3-digit CVV');
                isValid = false;
            }

            // Validate cardholder name
            if (!cardHolder || cardHolder.trim().length < 3) {
                showFieldError('cardHolderError', 'Please enter the cardholder name');
                isValid = false;
            }

            return isValid;
        }

        // Save payment method (modified version)
        async function savePaymentMethod() {
            try {
                showLoading(true);

                const email = userEmailInput.value;
                const cardNumber = cardNumberInput.value.replace(/\s/g, '');
                const expiryDate = expiryDateInput.value;
                const cvv = cvvInput.value;
                const cardHolder = document.getElementById('cardHolder').value;

                const response = await fetch('payment-methods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    credentials: 'include',
                    body: new URLSearchParams({
                        email: email,
                        cardNumber: cardNumber,
                        expiryDate: expiryDate,
                        cvv: cvv,
                        cardHolder: cardHolder
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save payment method');
                }

                showSuccess(result.message || 'Payment method saved successfully');
                resetForm();
                await loadPaymentMethods();
            } catch (error) {
                console.error('Error saving payment method:', error);
                showError(error.message || 'Failed to save payment method. Please try again.');
            } finally {
                showLoading(false);
            }
        }

// Add loading indicator function
        function showLoading(isLoading) {
            const saveBtn = document.getElementById('saveCardBtn');
            if (isLoading) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            } else {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Card';
            }
        }

        // Remove payment method
        async function removePaymentMethod() {
            try {
                const email = userEmailInput.value;

                const response = await fetch('payment-methods?email=' + encodeURIComponent(email), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to remove payment method');
                }

                showSuccess('Payment method removed successfully');
                loadPaymentMethods();
            } catch (error) {
                console.error('Error removing payment method:', error);
                showError('Failed to remove payment method. Please try again.');
            }
        }

        // Fill form with existing card data
        function fillFormWithExistingCardData() {
            // We'll only show the last 4 digits for editing
            const lastFour = document.getElementById('lastFour').textContent;
            document.getElementById('cardNumber').value = 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + lastFour;
            document.getElementById('expiryDate').value = document.getElementById('existingExpiry').textContent;
            document.getElementById('cvv').value = '';
            document.getElementById('cardHolder').value = document.getElementById('existingCardHolder').textContent;
        }

        // Logout user
        async function logoutUser() {
            try {
                const response = await fetch('logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    window.location.href = 'login.html?logout=success';
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showError('Logout failed. Please try again.');
            }
        }

        // Helper functions
        function resetForm() {
            paymentForm.reset();
            clearFieldErrors();
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showFieldError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function clearFieldErrors() {
            document.querySelectorAll('.field-error').forEach(el => {
                el.style.display = 'none';
            });
        }
    });
</script>
</body>
</html>